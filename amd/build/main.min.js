define(["jquery","core/ajax","core/notification","core/templates","core/str"],(function(e,t,i,n,s){return{init:function(e,t,i){this.courseID=e,this.inviteBody=t,this.roles=i,this.invites=[],"loading"===document.readyState?document.addEventListener("DOMContentLoaded",this.addInviteListener.bind(this)):this.addInviteListener()},addInviteListener:function(){let e=this;document.addEventListener("shareModalLoaded",(function(){document.getElementById("openInviteUsers").addEventListener("click",(t=>{t.preventDefault(),e.showModal()}))}))},showModal:function(){if(document.getElementById("inviteModal"))return e("#inviteModal").modal("show"),void document.querySelector(".modal-backdrop:last-of-type").setAttribute("style","z-index: 1060;");const t={courseID:this.courseID,inviteBody:this.inviteBody};n.render("local_invites/modal",t).done(function(t,i){document.body.insertAdjacentHTML("beforeend",t),n.runTemplateJS(i),e("#inviteModal").modal("show"),document.querySelector(".modal-backdrop:last-of-type").setAttribute("style","z-index: 1060;"),this.addModalListeners()}.bind(this)).fail((function(e){console.error("Failed to render template",e)}))},addModalListeners:function(){let d=this,a=document.getElementById("inviteModal"),o=a.querySelector("#userEmails"),r=a.querySelector("#addUser"),l=a.querySelector("#userList"),c=(a.querySelector("#addSuccess"),a.querySelector("#addError"),a.querySelector("#inviteUsers"));o.addEventListener("input",(function(){""===o.value.trim()?r.disabled=!0:r.disabled=!1})),r.addEventListener("click",(function(e){e.preventDefault(),t.call([{methodname:"local_invites_check_email",args:{courseid:d.courseID,emails:o.value},done:function(e){e.valid.forEach((e=>{if(-1==d.invites.indexOf(e.email)){const t={email:e.email,name:e.name,roles:d.roles};n.render("local_invites/userinvite",t).done(function(t,i){d.invites.push(e.email),l.appendChild(document.createRange().createContextualFragment(t)),d.updateStatus(),l.querySelector("li:last-child .delete-icon").addEventListener("click",(function(){d.invites=d.invites.filter((t=>t!==e.email)),d.updateStatus(),this.closest("li").remove()}))}.bind(this)).fail((function(e){console.error("Failed to render template",e)}))}})),e.valid.length>0&&s.get_string("validmessage","local_invites",e.valid.length).done((function(e){this.addSuccess.innerHTML=e,this.addSuccess.classList.remove("hidden"),setTimeout(function(){this.addSuccess.innerHTML="",this.addSuccess.classList.add("hidden")}.bind(this),3e3)})).fail(i.exception),e.invalid.length>0&&s.get_string("invalidmessage","local_invites",e.invalid.map((e=>e.email)).join(", ")).done((function(e){this.addError.innerHTML=e,this.addError.classList.remove("hidden"),setTimeout(function(){this.addError.innerHTML="",this.addError.classList.add("hidden")}.bind(this),3e3)})).fail(i.exception),o.value="",o.dispatchEvent(new Event("input")),d.updateStatus()}.bind(this),fail:i.exception}])})),c.addEventListener("click",(function(n){n.preventDefault();let o=[];l.querySelectorAll("li").forEach((e=>{let t=e.getAttribute("data-email"),i=e.querySelector("select").value;o.push({email:t,roleid:parseInt(i,10)})})),t.call([{methodname:"local_invites_send_invites",args:{courseid:d.courseID,invitations:o,message:a.querySelector("#inviteMessage").value},done:function(t){t.success?s.get_string("invitationssent","local_invites").done((function(t){this.addSuccess.innerHTML=t,this.addSuccess.classList.remove("hidden"),setTimeout(function(){this.addSuccess.innerHTML="",this.addSuccess.classList.add("hidden"),l.innerHTML="",d.invites=[],e("#inviteModal").modal("hide")}.bind(this),3e3)})).fail(i.exception):(this.addError.innerHTML=t.message,this.addError.classList.remove("hidden"),setTimeout(function(){this.addError.innerHTML="",this.addError.classList.add("hidden")}.bind(this),3e3)),d.updateStatus()}.bind(this),fail:i.exception}])}))},updateStatus:function(){let e=inviteModal.querySelector("#inviteDetails"),t=inviteModal.querySelector("#inviteUsers");0===this.invites.length?(e.classList.add("hidden"),t.disabled=!0):(e.classList.remove("hidden"),t.disabled=!1)}}}));