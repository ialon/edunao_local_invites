define(["jquery","core/ajax","core/notification","core/templates","core/str"],(function(e,t,i,n,d){return{init:function(e,t){this.courseID=e,this.inviteBody=t,this.invites=[],"loading"===document.readyState?document.addEventListener("DOMContentLoaded",this.moveMenuItem.bind(this)):this.moveMenuItem()},moveMenuItem:function(){let e=document.querySelector('li[data-key="inviteusers"] a');if(!e)return;let t=e.cloneNode(!0);t.removeAttribute("role"),t.removeAttribute("tabindex"),t.classList.remove("dropdown-item"),t.classList.add("btn","btn-sm","btn-info","d-flex","align-items-center","ml-3"),t.style.height="fit-content",t.innerHTML='<i class="fa fa-user-plus mr-2"></i> Send invites';let i=document.querySelector(".page-header-headings");i&&i.parentNode.insertBefore(t,i.nextSibling),t.addEventListener("click",(e=>{e.preventDefault(),this.showModal()})),e.addEventListener("click",(e=>{e.preventDefault(),this.showModal()}))},showModal:function(){if(document.getElementById("inviteModal"))return void e("#inviteModal").modal("show");const t={courseID:this.courseID,inviteBody:this.inviteBody};n.render("local_invites/modal",t).done(function(t,i){document.body.insertAdjacentHTML("beforeend",t),n.runTemplateJS(i),e("#inviteModal").modal("show"),this.addModalListeners()}.bind(this)).fail((function(e){console.error("Failed to render template",e)}))},addModalListeners:function(){let e=this,s=document.getElementById("inviteModal"),a=s.querySelector("#userEmails"),o=s.querySelector("#addUser"),l=s.querySelector("#userList");s.querySelector("#addSuccess"),s.querySelector("#addError");a.addEventListener("input",(function(){""===a.value.trim()?o.disabled=!0:o.disabled=!1})),o.addEventListener("click",(function(s){s.preventDefault(),t.call([{methodname:"local_invites_check_email",args:{emails:a.value},done:function(t){t.valid.forEach((t=>{if(-1==e.invites.indexOf(t.email)){const i={email:t.email,name:t.name};n.render("local_invites/userinvite",i).done(function(i,n){e.invites.push(t.email),l.appendChild(document.createRange().createContextualFragment(i)),e.updateStatus(),l.querySelector("li:last-child .delete-icon").addEventListener("click",(function(){e.invites=e.invites.filter((e=>e!==t.email)),e.updateStatus(),this.closest("li").remove()}))}.bind(this)).fail((function(e){console.error("Failed to render template",e)}))}})),t.valid.length>0&&d.get_string("validmessage","local_invites",t.valid.length).done((function(e){this.addSuccess.innerHTML=e,this.addSuccess.classList.remove("hidden"),setTimeout(function(){this.addSuccess.innerHTML="",this.addSuccess.classList.add("hidden")}.bind(this),3e3)})).fail(i.exception),t.invalid.length>0&&d.get_string("invalidmessage","local_invites",t.invalid.map((e=>e.email)).join(", ")).done((function(e){this.addError.innerHTML=e,this.addError.classList.remove("hidden"),setTimeout(function(){this.addError.innerHTML="",this.addError.classList.add("hidden")}.bind(this),3e3)})).fail(i.exception),a.value="",a.dispatchEvent(new Event("input")),e.updateStatus()}.bind(this),fail:i.exception}])}))},updateStatus:function(){let e=inviteModal.querySelector("#inviteDetails"),t=inviteModal.querySelector("#inviteUsers");0===this.invites.length?(e.classList.add("hidden"),t.disabled=!0):(e.classList.remove("hidden"),t.disabled=!1)}}}));