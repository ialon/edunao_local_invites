define(["jquery","core/ajax","core/notification","core/templates","core/str"],(function(e,i,t,n,s){return{init:function(e,i,t,n){this.courseID=e,this.inviteBody=i,this.roles=t,this.remaining=n,this.invites=[],"loading"===document.readyState?document.addEventListener("DOMContentLoaded",this.addInviteListener.bind(this)):this.addInviteListener()},addInviteListener:function(){let e=this;document.addEventListener("shareModalLoaded",(function(){document.getElementById("openInviteUsers").addEventListener("click",(i=>{i.preventDefault(),e.showModal()}))}))},showModal:function(){if(document.getElementById("inviteModal"))return e("#inviteModal").modal("show"),void document.querySelector(".modal-backdrop:last-of-type").setAttribute("style","z-index: 1060;");const i={courseID:this.courseID,inviteBody:this.inviteBody};n.render("local_invites/modal",i).done(function(i,t){document.body.insertAdjacentHTML("beforeend",i),n.runTemplateJS(t),e("#inviteModal").modal("show"),document.querySelector(".modal-backdrop:last-of-type").setAttribute("style","z-index: 1060;"),this.addModalListeners()}.bind(this)).fail((function(e){console.error("Failed to render template",e)}))},addModalListeners:function(){let d=this,a=document.getElementById("inviteModal"),o=a.querySelector("#userEmails"),r=a.querySelector("#addUser"),l=a.querySelector("#userList"),c=(a.querySelector("#addSuccess"),a.querySelector("#addError"),a.querySelector("#inviteUsers"));o.addEventListener("input",(function(){let e=this.remaining-this.invites.length;r.disabled=!1,e>0&&""===o.value.trim()&&(r.disabled=!0)})),r.addEventListener("click",(function(e){e.preventDefault(),i.call([{methodname:"local_invites_check_email",args:{courseid:d.courseID,emails:o.value},done:function(e){e.valid.forEach((e=>{if(-1==d.invites.indexOf(e.email)){const i={email:e.email,name:e.name,roles:d.roles};n.render("local_invites/userinvite",i).done(function(i,t){d.invites.push(e.email),l.appendChild(document.createRange().createContextualFragment(i)),d.updateStatus(),l.querySelector("li:last-child .delete-icon").addEventListener("click",(function(){d.invites=d.invites.filter((i=>i!==e.email)),d.updateStatus(),this.closest("li").remove()}))}.bind(this)).fail((function(e){console.error("Failed to render template",e)}))}})),e.valid.length>0&&s.get_string("validmessage","local_invites",e.valid.length).done((function(e){this.addSuccess.innerHTML=e,this.addSuccess.classList.remove("hidden"),setTimeout(function(){this.addSuccess.innerHTML="",this.addSuccess.classList.add("hidden")}.bind(this),3e3)})).fail(t.exception),e.invalid.length>0&&s.get_string("invalidmessage","local_invites",e.invalid.map((e=>e.email)).join(", ")).done((function(e){this.addError.innerHTML=e,this.addError.classList.remove("hidden"),setTimeout(function(){this.addError.innerHTML="",this.addError.classList.add("hidden")}.bind(this),3e3)})).fail(t.exception),o.value="",o.dispatchEvent(new Event("input")),d.updateStatus()}.bind(this),fail:t.exception}])})),c.addEventListener("click",(function(n){n.preventDefault();let o=[];l.querySelectorAll("li").forEach((e=>{let i=e.getAttribute("data-email"),t=e.querySelector("select").value;o.push({email:i,roleid:parseInt(t,10)})})),i.call([{methodname:"local_invites_send_invites",args:{courseid:d.courseID,invitations:o,message:a.querySelector("#inviteMessage").value},done:function(i){i.success?s.get_string("invitationssent","local_invites").done((function(i){this.addSuccess.innerHTML=i,this.addSuccess.classList.remove("hidden"),setTimeout(function(){this.addSuccess.innerHTML="",this.addSuccess.classList.add("hidden"),l.innerHTML="",d.invites=[],e("#inviteModal").modal("hide"),d.updateStatus()}.bind(this),3e3)})).fail(t.exception):(this.addError.innerHTML=i.message,this.addError.classList.remove("hidden"),setTimeout(function(){this.addError.innerHTML="",this.addError.classList.add("hidden")}.bind(this),3e3)),d.updateStatus()}.bind(this),fail:t.exception}])})),d.updateStatus()},updateStatus:function(){let e=inviteModal.querySelector(".remaining-invites"),i=inviteModal.querySelector("#inviteDetails"),n=inviteModal.querySelector("#inviteUsers"),d=inviteModal.querySelector("#addUser"),a=this.invites.length,o=this.remaining-a;s.get_string("remaininginvites","local_invites",o).done((function(i){e.innerHTML=i})).fail(t.exception),d.disabled=0==o,0===a?(i.classList.add("hidden"),n.disabled=!0):(i.classList.remove("hidden"),n.disabled=!1)}}}));