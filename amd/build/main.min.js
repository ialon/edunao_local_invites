define(["jquery","core/ajax","core/notification","core/templates","core/str"],(function(e,t,i,n,s){return{init:function(e,t,i){this.courseID=e,this.inviteBody=t,this.roles=i,this.invites=[],"loading"===document.readyState?document.addEventListener("DOMContentLoaded",this.moveMenuItem.bind(this)):this.moveMenuItem()},moveMenuItem:function(){let e=document.querySelector('li[data-key="inviteusers"] a');if(!e)return;let t=e.cloneNode(!0);t.removeAttribute("role"),t.removeAttribute("tabindex"),t.classList.remove("dropdown-item"),t.classList.add("btn","btn-sm","btn-info","d-flex","align-items-center","ml-3"),t.style.height="fit-content",t.innerHTML='<i class="fa fa-user-plus mr-2"></i> Send invites';let i=document.querySelector(".page-header-headings");i&&i.parentNode.insertBefore(t,i.nextSibling),t.addEventListener("click",(e=>{e.preventDefault(),this.showModal()})),e.addEventListener("click",(e=>{e.preventDefault(),this.showModal()}))},showModal:function(){if(document.getElementById("inviteModal"))return void e("#inviteModal").modal("show");const t={courseID:this.courseID,inviteBody:this.inviteBody};n.render("local_invites/modal",t).done(function(t,i){document.body.insertAdjacentHTML("beforeend",t),n.runTemplateJS(i),e("#inviteModal").modal("show"),this.addModalListeners()}.bind(this)).fail((function(e){console.error("Failed to render template",e)}))},addModalListeners:function(){let d=this,a=document.getElementById("inviteModal"),o=a.querySelector("#userEmails"),r=a.querySelector("#addUser"),l=a.querySelector("#userList"),c=(a.querySelector("#addSuccess"),a.querySelector("#addError"),a.querySelector("#inviteUsers"));o.addEventListener("input",(function(){""===o.value.trim()?r.disabled=!0:r.disabled=!1})),r.addEventListener("click",(function(e){e.preventDefault(),t.call([{methodname:"local_invites_check_email",args:{courseid:d.courseID,emails:o.value},done:function(e){e.valid.forEach((e=>{if(-1==d.invites.indexOf(e.email)){const t={email:e.email,name:e.name,roles:d.roles};n.render("local_invites/userinvite",t).done(function(t,i){d.invites.push(e.email),l.appendChild(document.createRange().createContextualFragment(t)),d.updateStatus(),l.querySelector("li:last-child .delete-icon").addEventListener("click",(function(){d.invites=d.invites.filter((t=>t!==e.email)),d.updateStatus(),this.closest("li").remove()}))}.bind(this)).fail((function(e){console.error("Failed to render template",e)}))}})),e.valid.length>0&&s.get_string("validmessage","local_invites",e.valid.length).done((function(e){this.addSuccess.innerHTML=e,this.addSuccess.classList.remove("hidden"),setTimeout(function(){this.addSuccess.innerHTML="",this.addSuccess.classList.add("hidden")}.bind(this),3e3)})).fail(i.exception),e.invalid.length>0&&s.get_string("invalidmessage","local_invites",e.invalid.map((e=>e.email)).join(", ")).done((function(e){this.addError.innerHTML=e,this.addError.classList.remove("hidden"),setTimeout(function(){this.addError.innerHTML="",this.addError.classList.add("hidden")}.bind(this),3e3)})).fail(i.exception),o.value="",o.dispatchEvent(new Event("input")),d.updateStatus()}.bind(this),fail:i.exception}])})),c.addEventListener("click",(function(n){n.preventDefault();let s=[];l.querySelectorAll("li").forEach((e=>{let t=e.getAttribute("data-email"),i=e.querySelector("select").value;s.push({email:t,roleid:parseInt(i,10)})})),t.call([{methodname:"local_invites_send_invites",args:{courseid:d.courseID,invitations:s,message:a.querySelector("#inviteMessage").value},done:function(t){t.success?(l.innerHTML="",d.invites=[],e("#inviteModal").modal("hide")):(this.addError.innerHTML=t.message,this.addError.classList.remove("hidden"),setTimeout(function(){this.addError.innerHTML="",this.addError.classList.add("hidden")}.bind(this),3e3)),d.updateStatus()}.bind(this),fail:i.exception}])}))},updateStatus:function(){let e=inviteModal.querySelector("#inviteDetails"),t=inviteModal.querySelector("#inviteUsers");0===this.invites.length?(e.classList.add("hidden"),t.disabled=!0):(e.classList.remove("hidden"),t.disabled=!1)}}}));