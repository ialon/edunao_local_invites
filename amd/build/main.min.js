define("local_invites/main",["jquery","core/ajax","core/notification","core/templates","core/str"],(function($,Ajax,Notification,Templates,Str){return{init:function(courseID,inviteBody,roles,remaining){this.courseID=courseID,this.inviteBody=inviteBody,this.roles=roles,this.remaining=remaining,this.invites=[],this.inviteModal=null,this.addSuccess=null,this.addError=null,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",this.addInviteListener.bind(this)):this.addInviteListener()},addInviteListener:function(){let that=this;document.addEventListener("shareModalLoaded",(function(){document.getElementById("openInviteUsers").addEventListener("click",(event=>{event.preventDefault(),that.showModal()}))}))},showModal:function(){if(document.getElementById("inviteModal"))return $("#inviteModal").modal("show"),void document.querySelector(".modal-backdrop:last-of-type").setAttribute("style","z-index: 1060;");const context={courseID:this.courseID,inviteBody:this.inviteBody};Templates.render("local_invites/modal",context).done(function(html,js){document.body.insertAdjacentHTML("beforeend",html),Templates.runTemplateJS(js),$("#inviteModal").modal("show"),document.querySelector(".modal-backdrop:last-of-type").setAttribute("style","z-index: 1060;"),this.addModalListeners()}.bind(this)).fail(Notification.exception)},addModalListeners:function(){this.inviteModal=document.getElementById("inviteModal"),this.addSuccess=this.inviteModal.querySelector("#addSuccess"),this.addError=this.inviteModal.querySelector("#addError");let that=this,userEmails=this.inviteModal.querySelector("#userEmails"),addUser=this.inviteModal.querySelector("#addUser"),userList=this.inviteModal.querySelector("#userList"),inviteUsers=this.inviteModal.querySelector("#inviteUsers");userEmails.addEventListener("input",(function(){let currentRemaining=this.remaining-that.invites.length;addUser.disabled=!1,currentRemaining>0&&""===userEmails.value.trim()&&(addUser.disabled=!0)})),addUser.addEventListener("click",(function(event){event.preventDefault(),Ajax.call([{methodname:"local_invites_check_email",args:{courseid:that.courseID,emails:userEmails.value},done:function(data){data.valid.forEach((result=>{if(-1==that.invites.indexOf(result.email)){const context={email:result.email,name:result.name,roles:that.roles};Templates.render("local_invites/userinvite",context).done(function(newUser){that.invites.push(result.email),userList.appendChild(document.createRange().createContextualFragment(newUser)),that.updateStatus(),userList.querySelector("li:last-child .delete-icon").addEventListener("click",(function(){that.invites=that.invites.filter((e=>e!==result.email)),that.updateStatus(),this.closest("li").remove()}))}.bind(this)).fail(Notification.exception)}})),data.valid.length>0&&Str.get_string("validmessage","local_invites",data.valid.length).done((function(message){this.addSuccess.innerHTML=message,this.addSuccess.classList.remove("hidden"),setTimeout(function(){this.addSuccess.innerHTML="",this.addSuccess.classList.add("hidden")}.bind(this),3e3)})).fail(Notification.exception),data.invalid.length>0&&Str.get_string("invalidmessage","local_invites",data.invalid.map((e=>e.email)).join(", ")).done((function(message){this.addError.innerHTML=message,this.addError.classList.remove("hidden"),setTimeout(function(){this.addError.innerHTML="",this.addError.classList.add("hidden")}.bind(this),3e3)})).fail(Notification.exception),userEmails.value="",userEmails.dispatchEvent(new Event("input")),that.updateStatus()}.bind(this),fail:Notification.exception}])})),inviteUsers.addEventListener("click",(function(event){event.preventDefault();let invitations=[];userList.querySelectorAll("li").forEach((user=>{let email=user.getAttribute("data-email"),roleid=user.querySelector("select").value;invitations.push({email:email,roleid:parseInt(roleid,10)})})),Ajax.call([{methodname:"local_invites_send_invites",args:{courseid:that.courseID,invitations:invitations,message:that.inviteModal.querySelector("#inviteMessage").value},done:function(data){data.success?Str.get_string("invitationssent","local_invites").done((function(message){this.addSuccess.innerHTML=message,this.addSuccess.classList.remove("hidden"),setTimeout(function(){this.addSuccess.innerHTML="",this.addSuccess.classList.add("hidden"),userList.innerHTML="",that.invites=[],$("#inviteModal").modal("hide"),that.updateStatus()}.bind(this),3e3)})).fail(Notification.exception):(this.addError.innerHTML=data.message,this.addError.classList.remove("hidden"),setTimeout(function(){this.addError.innerHTML="",this.addError.classList.add("hidden")}.bind(this),3e3)),that.updateStatus()}.bind(this),fail:Notification.exception}])})),that.updateStatus()},updateStatus:function(){let remainingInvites=this.inviteModal.querySelector(".remaining-invites"),inviteDetails=this.inviteModal.querySelector("#inviteDetails"),inviteUsers=this.inviteModal.querySelector("#inviteUsers"),addUser=this.inviteModal.querySelector("#addUser"),invites=this.invites.length,currentRemaining=this.remaining-invites;Str.get_string("remaininginvites","local_invites",currentRemaining).done((function(message){remainingInvites.innerHTML=message})).fail(Notification.exception),addUser.disabled=0==currentRemaining,0===invites?(inviteDetails.classList.add("hidden"),inviteUsers.disabled=!0):(inviteDetails.classList.remove("hidden"),inviteUsers.disabled=!1)}}}));

//# sourceMappingURL=main.min.js.map